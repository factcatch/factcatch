<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- <meta charset="UTF-8"> -->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/style.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/modal.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/font.css') }}">
    <!-- <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/graph.css') }}"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- <link href='https://fonts.googleapis.com/css?family=Open+Sans|Open+Sans+Condensed:300,700' rel='stylesheet' type='text/css'> -->
    <!-- <script type="text/javascript" src="{{ url_for('static', filename='js/fact.js') }}"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script> -->

    <script src="https://d3js.org/d3.v4.min.js"></script>
    <!-- <script src="//d3js.org/d3-scale-chromatic.v1.min.js"></script> -->

    <!-- conversation -->
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Fact Checking</title>
    <link rel='stylesheet' id='style-css' href="{{ url_for('static', filename='styles/style_conservation.css') }}"
        type='text/css' media='all' />

    <style>
        svg {
            font: 12px sans-serif;
        }

        text {
            pointer-events: none;
        }

        .inner_node rect {
            pointer-events: all;
        }

        .inner_node rect.highlight {
            stroke: #315B7E;
            stroke-width: 2px;
        }

        .outer_node circle {
            /* fill: #fff; */
            /* fill: #0da4d3; */
            fill: #666;
            /* stroke: steelblue; */
            stroke: black;
            stroke-width: 1.5px;
            pointer-events: all;
        }

        .outer_node circle.highlight {
            stroke: #315B7E;
            stroke-width: 2px;
        }

        .link {
            fill: none;
        }
    </style>

</head>

<body>
    <div id="budget-modal" class="modal">
        <!-- Modal content -->
        <div class="modal-content">
            <div class="modal-header">
                <span class="close">&times;</span>
                <h2>Optimize Budget Allocation</h2>
            </div>
            <div class="modal-body">
                <form method=post action="/" enctype=multipart/form-data> <h4>Budget</h4>
                    <input type=number value=0 name=budget style="font-size: 18px;">
                    <input type="submit" value="OK" class="button">
                </form>
            </div>
            <!-- <div class="modal-footer">
                <h3>Modal Footer</h3>
            </div> -->
        </div>
    </div>
    <div class="grid-container">
        <div class="header">
            <div class="grid-header">
                <div id="logo-griffith">
                    <a href="/">
                        <!-- <img width="180px" height="60px" src="./static/img/logo.png"> -->
                        <div>Fact Checking</div>
                    </a>
                </div>
                <div id="select-file" class="header-content">
                    <form method=post action="/upload" enctype=multipart/form-data> 
                    <input type="file" name="file" id="file" class="inputfile" data-multiple-caption="{count} files selected" multiple/>
                    <input type=submit value=Upload id="upload-btn">
                    </form>
                </div>
                <div class="header-content" style="text-align: right;">
                    <button class="button">
                        <a href="/download" style="color: white">Take Snapshot</a>
                    </button>
                    <!-- <a class="button" href="/download">Take Snapshot</a> -->
                    <button class="button" id="myBtn">Optimize Budget Allocation</button>
                    <button class="button">Stop Feedback</button>
                </div>
            </div>
        </div>
        <div id="block-content">
            <div>
                <div id="title-list-claim">
                    <span>Claims</span>
                    <input type="text" id="input-for-claim" onkeyup="searchClaim()" placeholder="Search for claims.."
                        title="Type in a name">
                </div>
                <div id="block-list-claim">
                    <ul id="list-claim">
                        {% for claim in data %}
                        <li onclick="selectClaim({{ loop.index }},{{ claim }});drawRelation({{ claim }})"
                            id="{{ claim['Claim_ID'] }}">
                            <!-- <div class="icon-credibility">
                                <i class="fa fa-check-circle" aria-hidden="true" style="font-size: 24px;"></i>
                            </div> -->
                            <div>
                                <span class="no-claim">{{ loop.index }}. </span> {{ claim["Claim"] }}
                            </div>
                            <div class="container">
                                <div class="progress2 progress-moved">
                                    <div class="progress-bar2">
                                    </div>
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="detail content">
                <!-- <div id="header-claim">
                    <span id="no-claim">1.</span>
                    <span id="title-claim">{{ data[0]["Claim"] }}</span>
                </div> -->
                <div style="height: 560px;">
                    <div class="tab">
                        <button class="tablinks" onclick="openCity(event,'info-claim')" id="defaultOpen">Detail</button>
                        <button class="tablinks" onclick="openCity(event, 'relations')">Relations</button>
                        <button class="tablinks" onclick="openCity(event, 'sources')">Sources</button>
                        <div>
                            <form method=post action="/process">
                                <input type="hidden" name="claimId" value="{{ data[0].Claim_ID }}">
                                <!-- <div class="validation-claim"> -->
                                <input type=submit style="margin-right: 30px;" class="btn-validation" name="Credibility"
                                    value="Non-Credibility">
                                <input type=submit class="btn-validation" name="Credibility" value="Credibility">
                                <!-- </div> -->
                            </form>
                        </div>
                    </div>
                    <div id="info-claim" class="tabcontent item-tab">
                        <!-- <span onclick="this.parentElement.style.display='none'" class="topright">&times</span> -->
                        <!-- <h3>London</h3> -->
                        <!-- <div id="info-claim"> -->
                        <div>
                            <div>
                                <h4>
                                    Origins
                                </h4>
                                <p id="origins-claim">
                                    {{ data[0]["Origins"] }}
                                </p>
                            </div>
                            <div>
                                <h4>
                                    Description
                                </h4>
                                <span>
                                    <span id="description-short">
                                        {{ data[0]["Description"][:100] }}
                                    </span>
                                    <span id="dots">...</span>
                                    <span id="more">
                                        {{ data[0]["Description"][100:]}}
                                    </span>

                                    <button onclick="readMore()" id="btn-readmore" class="button">Read more</button>
                            </div>
                            <div>
                                <h4>
                                    Example
                                </h4>
                                <p id="example-claim">
                                    {{ data[0]["Example"] }}
                                </p>
                            </div>
                            <div>
                                <h4>
                                    Originally Published
                                </h4>
                                <p id="originally-published-claim">
                                    {{ data[0]["Originally Published"] }}
                                    <!-- 22 July 2015 -->
                                </p>
                            </div>
                            <div>
                                <h4>
                                    Last Updated
                                </h4>
                                <p id="last-updated-claim">
                                    {{ data[0]["Last Updated"] }}
                                    <!-- 4 December 2015 -->
                                </p>
                            </div>
                            <div id="tag-claim">
                                {% for tag in data[0]["Tags"]%}
                                <span class="tag-claim-item"> #{{ tag }} </span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>


                    <div id="relations" class="tabcontent item-tab">
                        <!-- <span onclick="this.parentElement.style.display='none'" class="topright">&times</span> -->
                        <div id="relation-claim" style="overflow: auto; width: 900px; height: 100%;">
                        </div>
                    </div>

                    <div id="sources" class="tabcontent item-tab">
                        <div class="chart"
                            style="grid-column-start:1;grid-column-end: 3;text-align: center;background-color: #fff;">
                        </div>
                    </div>

                    <!-- <div>
                        <form method=post action="/process">
                            <input type="hidden" name="claimId" value="{{ data[0].Claim_ID }}">
                            <div class="validation-claim">
                                <input type=submit class="button btn-validation" name="Credibility" value="Credibility">
                                <input type=submit class="button btn-validation" name="Credibility"
                                    value="Non-Credibility">
                            </div>
                        </form>
                    </div> -->
                </div>
            </div>
        </div>
    </div>

    <!-- <div id="main" style="grid-column-start:1;grid-column-end: 3;">
        <h3 style="padding-left:30px">Sources of Claim</h3>
        <div id="graph" style="text-align:center"></div>
        <div id="graph-info"></div>
    </div> -->
    <script type="text/javascript" src="{{ url_for('static', filename='js/d3.v3.min.js') }}"></script>
    <!-- <script src="https://d3js.org/d3.v4.min.js"></script> -->
    <script type="text/javascript" src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
    <!-- <script type="text/javascript" src="{{ url_for('static', filename='js/conversation.min.js') }}"></script> -->

    <script>

        function drawRelation(claim) {
            d3.select(".chart > svg").remove();

            var sources = claim["Sources Relation"];
            var data = JSON.parse(sources);


            // transform the data into a useful representation
            // 1 is inner, 2, is outer

            // need: inner, outer, links
            //
            // inner: 
            // links: { inner: outer: }


            var outer = d3.map();
            var inner = [];
            var links = [];
            var outerId = [0];

            data.forEach(function (d) {

                if (d == null)
                    return;

                i = { id: 'i' + inner.length, name: d[0], content: d[1], related_links: [] };
                i.related_nodes = [i.id];
                inner.push(i);

                if (!Array.isArray(d[2]))
                    d[2] = [d[2]];

                d[2].forEach(function (d1) {

                    o = outer.get(d1);

                    if (o == null) {
                        o = { name: d1, id: 'o' + outerId[0], related_links: [] };
                        o.related_nodes = [o.id];
                        outerId[0] = outerId[0] + 1;

                        outer.set(d1, o);
                    }

                    // create the links
                    l = { id: 'l-' + i.id + '-' + o.id, inner: i, outer: o }
                    links.push(l);

                    // and the relationships
                    i.related_nodes.push(o.id);
                    i.related_links.push(l.id);
                    o.related_nodes.push(i.id);
                    o.related_links.push(l.id);
                });
            });

            data = {
                inner: inner,
                outer: outer.values(),
                links: links
            }

            // sort the data -- TODO: have multiple sort options
            outer = data.outer;
            data.outer = Array(outer.length);


            var i1 = 0;
            var i2 = outer.length - 1;

            for (var i = 0; i < data.outer.length; ++i) {
                if (i % 2 == 1)
                    data.outer[i2--] = outer[i];
                else
                    data.outer[i1++] = outer[i];
            }

            console.log(data.outer.reduce(function (a, b) { return a + b.related_links.length; }, 0) / data.outer.length);


            // from d3 colorbrewer: 
            // This product includes color specifications and designs developed by Cynthia Brewer (http://colorbrewer.org/).
            var colors = ["#a50026", "#d73027", "#f46d43", "#fdae61", "#fee090", "#ffffbf", "#e0f3f8", "#abd9e9", "#74add1", "#4575b4", "#313695"]
            // var colors = ["#001f3f","#0074D9","#7FDBFF","#39CCCC","#3D9970","#2ECC40","#01FF70","#FFDC00","#FF851B","#FF4136","#F012BE"]
            // var colors = d3.scaleQuantize()
            //     .domain([100, 200])
            //     .range(["#5E4FA2", "#3288BD", "#66C2A5", "#ABDDA4", "#E6F598",
            //         "#FFFFBF", "#FEE08B", "#FDAE61", "#F46D43", "#D53E4F", "#9E0142"]);
            var color = d3.scale.linear()
                .domain([10, 220])
                .range([colors.length - 1, 0])
                .clamp(true);

            // var diameter = 960;
            var diameter = 800;

            var rect_width = 200;
            var rect_height = 20;

            var link_width = "1px";

            var il = data.inner.length;
            var ol = data.outer.length;

            var inner_y = d3.scale.linear()
                .domain([0, il])
                .range([-(il * rect_height) / 2, (il * rect_height) / 2]);

            mid = (data.outer.length / 2.0)
            var outer_x = d3.scale.linear()
                .domain([0, mid, mid, data.outer.length])
                .range([15, 170, 190, 355]);

            var outer_y = d3.scale.linear()
                .domain([0, data.outer.length])
                .range([0, diameter / 2 - 120]);


            // setup positioning
            data.outer = data.outer.map(function (d, i) {
                d.x = outer_x(i);
                d.y = diameter / 3;
                return d;
            });

            data.inner = data.inner.map(function (d, i) {
                d.x = -(rect_width / 2);
                d.y = inner_y(i);
                return d;
            });


            function get_color(name) {
                var c = Math.round(color(name));
                if (isNaN(c))
                    return '#dddddd';	// fallback color

                return colors[c];
            }

            // Can't just use d3.svg.diagonal because one edge is in normal space, the
            // other edge is in radial space. Since we can't just ask d3 to do projection
            // of a single point, do it ourselves the same way d3 would do it.  


            function projectX(x) {
                return ((x - 90) / 180 * Math.PI) - (Math.PI / 2);
            }

            var diagonal = d3.svg.diagonal()
                .source(function (d) {
                    return {
                        "x": d.outer.y * Math.cos(projectX(d.outer.x)),
                        "y": -d.outer.y * Math.sin(projectX(d.outer.x))
                    };
                })
                .target(function (d) {
                    return {
                        "x": d.inner.y + rect_height / 2,
                        "y": d.outer.x > 180 ? d.inner.x : d.inner.x + rect_width
                    };
                })
                .projection(function (d) { return [d.y, d.x]; });


            var svg = d3.select(".chart").append("svg")
                .attr("width", diameter)
                .attr("height", diameter)
                .append("g")
                .attr("transform", "translate(" + diameter / 2 + "," + diameter / 2 + ")");


            // links
            var link = svg.append('g').attr('class', 'links').selectAll(".link")
                .data(data.links)
                .enter().append('path')
                .attr('class', 'link')
                .attr('id', function (d) { return d.id })
                .attr("d", diagonal)
                .attr('stroke', function (d) { return "gray"/*get_color(d.inner.name);*/ })
                .attr('stroke-width', link_width);

            // outer nodes

            var onode = svg.append('g').selectAll(".outer_node")
                .data(data.outer)
                .enter().append("g")
                .attr("class", "outer_node")
                .attr("transform", function (d) { return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")"; })
                .on("mouseover", mouseover)
                .on("mouseout", mouseout);

            onode.append("circle")
                .attr('id', function (d) { return d.id })
                .attr("r", 6.5);

            onode.append("circle")
                .attr('r', 20)
                .attr('visibility', 'hidden');

            onode.append("text")
                .attr('id', function (d) { return d.id + '-txt'; })
                .attr("dy", ".31em")
                .attr("text-anchor", function (d) { return d.x < 180 ? "start" : "end"; })
                .attr("transform", function (d) { return d.x < 180 ? "translate(8)" : "rotate(180)translate(-8)"; })
                .text(function (d) { return d.name; });

            // inner nodes

            var inode = svg.append('g').selectAll(".inner_node")
                .data(data.inner)
                .enter().append("g")
                .attr("class", "inner_node")
                .attr("transform", function (d, i) { return "translate(" + d.x + "," + d.y + ")" })
                .on("mouseover", mouseover)
                .on("mouseout", mouseout)
                .append("a")
                .attr("target", "_blank")
                .attr("href", function (d) { return "https://" + d.content; });

            inode.append('rect')
                .attr('width', rect_width)
                .attr('height', rect_height)
                .attr('id', function (d) { return d.id; })
                .attr('fill', function (d) { return get_color(d.name); });

            inode.append("text")
                .attr('id', function (d) { return d.id + '-txt'; })
                .attr('text-anchor', 'middle')
                .attr("transform", "translate(" + rect_width / 2 + ", " + rect_height * .75 + ")")
                .text(function (d) { return d.content; });

            // need to specify x/y/etc

            d3.select(self.frameElement).style("height", diameter - 150 + "px");

            function mouseover(d) {
                // bring to front
                d3.selectAll('.links .link').sort(function (a, b) { return d.related_links.indexOf(a.id); });

                for (var i = 0; i < d.related_nodes.length; i++) {
                    d3.select('#' + d.related_nodes[i]).classed('highlight', true);
                    d3.select('#' + d.related_nodes[i] + '-txt').attr("font-weight", 'bold');
                }

                for (var i = 0; i < d.related_links.length; i++)
                    d3.select('#' + d.related_links[i]).attr('stroke-width', '4px').attr('stroke', "#0da4d3");
            }

            function mouseout(d) {
                for (var i = 0; i < d.related_nodes.length; i++) {
                    d3.select('#' + d.related_nodes[i]).classed('highlight', false);
                    d3.select('#' + d.related_nodes[i] + '-txt').attr("font-weight", 'normal');
                }

                for (var i = 0; i < d.related_links.length; i++)
                    d3.select('#' + d.related_links[i]).attr('stroke-width', link_width).attr('stroke', 'gray');
            }
        };

        $(document).ready(function () {
            document.getElementById('{{ data[0]["Claim_ID"] }}').click();
        });
    </script>
</body>
<script type="text/javascript" src="{{ url_for('static', filename='js/modal.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/search.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/fact.js') }}"></script>

<!-- <script type="text/javascript" src="{{ url_for('static', filename='js/graph.js') }}"></script> -->
<script>
    // var width = 900,
    //     height = 500,
    //     nodeSize = 15;
    var width = 900,
        height = 2000,
        nodeSize = 15;

    // var color = d3.scale.category20();
    function colorScale(layer) {
        var rangeColor;
        switch (layer) {
            case 1:
                rangeColor = ["gray", "blue"]
                break;
            case 2:
                rangeColor = ["gray", "red"]
                break;
            case 3:
                rangeColor = ["gray", "orange"]
                break
            default:
                break;
        }
        var colorScale = d3.scale.linear()
            .domain([0, 100])
            .range(rangeColor);
        return colorScale;
    }


    var svg = d3.select("#relation-claim").append("svg")
        .attr("width", width)
        .attr("height", height);

    // d3.json("{{ url_for('static', filename='data/data-neuron.json') }}", function (error, graph) {
    // var nodes = graph.nodes;
    // var linkNodes = graph.links;
    // var nodes = '{{  data[0]["Google Results"]["nodes"] }}';
    // var linkNodes = '{{ data[0]["Google Results"]["links"] }}';
    // var results = '{{  data[0]["Google Results"] }}';
    // var data = '{{  data[0]["Google Results"] | safe}}';
    // data = data.replace(/\\n/g, "\\n");
    var results = JSON.parse('{{  data[0]["Google Results"] | safe}}');
    console.log(results);
    // var results = JSON.parse(data);

    var nodes = results.nodes;
    var linkNodes = results.links;

    // get network size
    var netsize = {};
    nodes.forEach(function (d) {
        if (d.layer in netsize) {
            netsize[d.layer] += 1;
        } else {
            netsize[d.layer] = 1;
        }
        d["lidx"] = netsize[d.layer];
    });

    // calc distances between nodes
    var largestLayerSize = Math.max.apply(
        null, Object.keys(netsize).map(function (i) { return netsize[i]; }));

    var xdist = width / Object.keys(netsize).length,
        ydist = (height - 15) / largestLayerSize;

    // create node locations
    nodes.map(function (d) {
        d["x"] = (d.layer - 0.5) * xdist * 0.75;
        // d["y"] = (d.lidx - 0.5) * ydist * 0.7;
        d["y"] = (((d.lidx - 0.5) + ((largestLayerSize - netsize[d.layer]) / 2)) * ydist * 0.7) + 2;
    });

    // autogenerate links
    var links = [];
    linkNodes.map(function (d, i) {
        links.push({ "source": d.source, "target": d.target, "value": 1 });
    }).filter(function (d) { return typeof d !== "undefined"; });

    // draw links
    var link = svg.selectAll(".link")
        .data(links)
        .enter().append("line")
        .attr("class", "link")
        .attr("x1", function (d) { return nodes[d.source].x; })
        .attr("y1", function (d) { return nodes[d.source].y; })
        .attr("x2", function (d) { return nodes[d.target].x; })
        .attr("y2", function (d) { return nodes[d.target].y; })
        .style("stroke-width", function (d) { return 2; });

    // draw nodes
    var node = svg.selectAll(".node")
        .data(nodes)
        .enter().append("g")
        .attr("transform", function (d) {
            return "translate(" + d.x + "," + d.y + ")";
        }
        );

    var circle = node.append("circle")
        .attr("class", "node")
        .attr("r", nodeSize)
        .style("fill", function (d) { return colorScale(d.layer)(d.reliability); });


    node.append("a")
        .attr("href", "https://www.youtube.com/")
        .append("text")
        .attr("dx", "-55px")
        .attr("dy", "-25px")
        .attr("font-size", "12px")
        .text(function (d) { return d.label; });
    // });
</script>

</html>